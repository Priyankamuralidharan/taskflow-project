<!DOCTYPE html>
<html>
<head>
  <title>TaskFlow - User View</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    tr.pending {
      background-color: #fffbe6;
    }
    tr.completed {
      background-color: #e6ffe6;
    }
    tr:hover {
      background-color: #d0e7ff;
    }
    img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 5px;
    }
    input[type="file"] {
      margin-top: 5px;
    }
    button {
      margin-left: 5px;
    }
  </style>
</head>
<body>

<h2>Task List</h2>

<!-- Add Task Section -->
<input type="text" id="newTaskTitle" placeholder="New task title">
<input type="file" id="taskImage" accept="image/*">
<button onclick="addTask()">Add Task</button>

<table id="taskTable">
  <thead>
    <tr>
      <th>SL No.</th>
      <th>Image</th>
      <th>Title</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const apiUrl = "http://localhost:4000/api/tasks";
  const defaultImage = "https://via.placeholder.com/50?text=Img";

  // Load all tasks
  async function loadTasks() {
    try {
      const res = await fetch(apiUrl);
      if (!res.ok) throw new Error("Failed to fetch tasks");
      const tasks = await res.json();

      const tbody = document.querySelector("#taskTable tbody");
      tbody.innerHTML = "";

      if (tasks.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5">No tasks found.</td></tr>`;
        return;
      }

      tasks.forEach((task, index) => {
        const tr = document.createElement("tr");
        tr.className = task.status === "completed" ? "completed" : "pending";

        const imgSrc = task.imageUrl ? task.imageUrl : defaultImage;

        tr.innerHTML = `
          <td>${index + 1}</td>
          <td><img src="${imgSrc}" alt="Task Image"></td>
          <td>${task.title}</td>
          <td>${task.status}</td>
          <td>
            ${task.status !== "completed" ? `<button onclick="markCompleted(${task.id})">Complete</button>` : ""}
            <button onclick="deleteTask(${task.id})">Delete</button>
          </td>
        `;

        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error(err);
      alert("Error loading tasks: " + err.message);
    }
  }

  // Add new task
  async function addTask() {
    const title = document.getElementById("newTaskTitle").value.trim();
    const imageFile = document.getElementById("taskImage").files[0];

    if (!title) {
      alert("Task title cannot be empty!");
      return;
    }

    let imageUrl = null;
    if (imageFile) {
      // Convert image to Base64
      imageUrl = await toBase64(imageFile);
    }

    try {
      const res = await fetch(apiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, status: "pending", imageUrl })
      });
      if (!res.ok) throw new Error("Failed to add task");

      document.getElementById("newTaskTitle").value = "";
      document.getElementById("taskImage").value = null;
      loadTasks(); // Refresh task list
    } catch (err) {
      console.error(err);
      alert("Error adding task: " + err.message);
    }
  }

  // Convert image file to Base64 string
  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }

  // Mark task as completed
  async function markCompleted(id) {
    try {
      const res = await fetch(`${apiUrl}/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: "completed" })
      });
      if (!res.ok) throw new Error("Failed to update task");
      loadTasks();
    } catch (err) {
      console.error(err);
      alert("Error marking task completed: " + err.message);
    }
  }

  // Delete task
  async function deleteTask(id) {
    if (!confirm("Are you sure you want to delete this task?")) return;
    try {
      const res = await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
      if (!res.ok) throw new Error("Failed to delete task");
      loadTasks();
    } catch (err) {
      console.error(err);
      alert("Error deleting task: " + err.message);
    }
  }

  // Initial load
  loadTasks();
</script>

</body>
</html>
